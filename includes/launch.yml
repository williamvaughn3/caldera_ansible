---

  - name: "check if {{ caldera_install_root_dir }}/caldera.pid exists"
    stat: 
      path: "{{ caldera_install_root_dir }}/caldera.pid"
    register: caldera_pid_check
    tags: [ launch, pid_check ]
    ignore_errors: true

  - name: kill process if pid file exists
    shell: "kill -9 $(cat {{ caldera_install_root_dir }}/caldera.pid)"
    when: caldera_pid_check.stat.exists
    tags: [ launch, pid_check ]
    
  - name: launch and register the stander out and error
    raw: |
      "cd {{ caldera_install_root_dir }}/caldera;
      nohup /usr/bin/python3 {{ caldera_install_root_dir }}/caldera/server.py --insecure &;" "echo $! > {{ caldera_install_root_dir }}/caldera.pid"
    tags: [ launch, server, write_pid ]

  - name: pause for 20 seconds
    pause:
      seconds: 20
    tags: [ launch, pause ]

  - name: "Check if the server is running"
    raw: |
      "ps -ef | grep server.py | grep -v grep"
    register: server_running
    tags: [ launch, check_running ]

  - name: debug the output
    debug:
      var: server_running
    tags: [ launch_output, print_output ]

  - name: "Register nohup.out"
    raw: |
      "cat {{ caldera_install_root_dir }}/caldera/nohup.out"
    register: nohup_out
    tags: [ launch_output ]

  - name: debug the output
    debug:
      var: nohup_out
    tags: [ launch_output ]

  - name: Fix Broken openssl
    pip3:
      name: pyopenssl
      state: latest
      force: yes
...

